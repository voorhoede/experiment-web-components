<div class="color-picker-svelte">
  <div on:input="onInput(event)" on:change="onChange(event)" ref:input>
    <slot>
      {#if hue}
        <input type="range" min="0" max="360" value="{inputValue}">
      {:else}
        <input type="range" min="0" max="360">
      {/if}
    </slot>
  </div>
  <div class="color-picker-svelte__output" style="background-color: hsl({inputValue}, 100%, 50%)"></div>
  <span>{value}</span>
</div>

<script>
function hslToRgb(h, s, l){
  var r, g, b;

  if(s == 0){
      r = g = b = l; // achromatic
  }else{
      var hue2rgb = function hue2rgb(p, q, t){
          if(t < 0) t += 1;
          if(t > 1) t -= 1;
          if(t < 1/6) return p + (q - p) * 6 * t;
          if(t < 1/2) return q;
          if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
      }

      var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      var p = 2 * l - q;
      r = hue2rgb(p, q, h + 1/3);
      g = hue2rgb(p, q, h);
      b = hue2rgb(p, q, h - 1/3);
  }

  return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}

function componentToHex(c) {
  var hex = c.toString(16);
  return hex.length == 1 ? "0" + hex : hex;
}

export default {
  tag: 'color-picker-svelte',

  data() {
    return {
      inputValue: 0,
      value: ''
    }
  },

  onstate({changed, current}) {
    if (changed.inputValue === true) {
      const [r, g, b] = hslToRgb(Number(current.inputValue) / 360 , 1, 0.5)
      const value = `#${componentToHex(r)}${componentToHex(g)}${componentToHex(b)}`
      this.set({value})
    }
  },

  oncreate() {
    const inputElement = this.refs.input.querySelector('input')
    const data = this.options.data || {}
    if (data.hasOwnProperty('hue')) {
      this.set({inputValue: Number(data.hue)})
    } else {
      this.set({inputValue: Number(inputElement.value)})
    }
  },

  methods: {
    onInput(event) {
      this.set({ inputValue: Number(event.target.value) })
      this.fire('input', {value: this.value})
    },
    onChange() {
      this.fire('change', {value: this.value})
    },
  }
}
</script>

<style>
  .color-picker-svelte {
    display: inline-flex;
  }

  .color-picker-svelte__output {
    display: inline-block;
    width: 2em;
    height: 2em;
    background-color: red;
    margin-left: 0.5em;
  }
</style>
